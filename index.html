<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Water Finder Enhanced</title>
  <!-- Leaflet CSS embedded -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIldhdGVyIEZpbmRlciIsCiAgInNob3J0X25hbWUiOiAiV2F0ZXJGaW5kZXIiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMxOTc2ZDIiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNU5qQWdPVFl3SWo0OFkyOXNiM0lnWW1GelpTMWpiMnh2Y2owaVl6QTBOMkZtWmlJZ1ptbHNiRDBpWTJZeVpEYzNabVlpTHo0OEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ=="/>
  <style>
    /* Leaflet CSS - Essential styles */
    .leaflet-pane,
    .leaflet-tile,
    .leaflet-marker-icon,
    .leaflet-marker-shadow,
    .leaflet-tile-container,
    .leaflet-pane > svg,
    .leaflet-pane > canvas,
    .leaflet-zoom-box,
    .leaflet-image-layer,
    .leaflet-layer {
      position: absolute;
      left: 0;
      top: 0;
    }
    .leaflet-container {
      overflow: hidden;
    }
    .leaflet-tile,
    .leaflet-marker-icon,
    .leaflet-marker-shadow {
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
    }
    .leaflet-marker-icon,
    .leaflet-marker-shadow {
      display: block;
    }
    .leaflet-container .leaflet-overlay-pane svg,
    .leaflet-container .leaflet-marker-pane img,
    .leaflet-container .leaflet-shadow-pane img,
    .leaflet-container .leaflet-tile-pane img,
    .leaflet-container img.leaflet-image-layer,
    .leaflet-container .leaflet-tile {
      max-width: none !important;
      max-height: none !important;
    }
    .leaflet-container.leaflet-touch-zoom {
      -ms-touch-action: pan-x pan-y;
      touch-action: pan-x pan-y;
    }
    .leaflet-container.leaflet-touch-drag {
      -ms-touch-action: pinch-zoom;
      touch-action: none;
      touch-action: pinch-zoom;
    }
    .leaflet-container.leaflet-touch-drag.leaflet-touch-zoom {
      -ms-touch-action: none;
      touch-action: none;
    }
    .leaflet-container {
      -webkit-tap-highlight-color: transparent;
    }
    .leaflet-container a {
      -webkit-tap-highlight-color: rgba(51, 181, 229, 0.4);
    }
    .leaflet-tile {
      filter: inherit;
      visibility: hidden;
    }
    .leaflet-tile-loaded {
      visibility: inherit;
    }
    .leaflet-zoom-box {
      width: 0;
      height: 0;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      z-index: 800;
    }
    .leaflet-overlay-pane svg {
      -moz-user-select: none;
    }
    .leaflet-pane { z-index: 400; }
    .leaflet-tile-pane { z-index: 200; }
    .leaflet-overlay-pane { z-index: 400; }
    .leaflet-shadow-pane { z-index: 500; }
    .leaflet-marker-pane { z-index: 600; }
    .leaflet-tooltip-pane { z-index: 650; }
    .leaflet-popup-pane { z-index: 700; }
    .leaflet-map-pane canvas { z-index: 100; }
    .leaflet-map-pane svg { z-index: 200; }
    .leaflet-vml-shape {
      width: 1px;
      height: 1px;
    }
    .lvml {
      behavior: url(#default#VML);
      display: inline-block;
      position: absolute;
    }

    /* Leaflet controls */
    .leaflet-control {
      position: relative;
      z-index: 800;
      pointer-events: visiblePainted;
      pointer-events: auto;
    }
    .leaflet-top,
    .leaflet-bottom {
      position: absolute;
      z-index: 1000;
      pointer-events: none;
    }
    .leaflet-top {
      top: 0;
    }
    .leaflet-right {
      right: 0;
    }
    .leaflet-bottom {
      bottom: 0;
    }
    .leaflet-left {
      left: 0;
    }
    .leaflet-control {
      float: left;
      clear: both;
    }
    .leaflet-right .leaflet-control {
      float: right;
    }
    .leaflet-top .leaflet-control {
      margin-top: 10px;
    }
    .leaflet-bottom .leaflet-control {
      margin-bottom: 10px;
    }
    .leaflet-left .leaflet-control {
      margin-left: 10px;
    }
    .leaflet-right .leaflet-control {
      margin-right: 10px;
    }

    /* Popup styles */
    .leaflet-popup {
      position: absolute;
      text-align: center;
      margin-bottom: 20px;
    }
    .leaflet-popup-content-wrapper {
      padding: 1px;
      text-align: left;
      border-radius: 12px;
      background: white;
      box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
    .leaflet-popup-content {
      margin: 13px 19px;
      line-height: 1.6;
      font-size: 13px;
      font-size: 1.08333em;
      min-height: 1px;
    }
    .leaflet-popup-content p {
      margin: 18px 0;
    }
    .leaflet-popup-tip-container {
      width: 40px;
      height: 20px;
      position: absolute;
      left: 50%;
      margin-left: -20px;
      overflow: hidden;
      pointer-events: none;
    }
    .leaflet-popup-tip {
      width: 17px;
      height: 17px;
      padding: 1px;
      margin: -10px auto 0;
      -webkit-transform: rotate(45deg);
      -moz-transform: rotate(45deg);
      -ms-transform: rotate(45deg);
      transform: rotate(45deg);
      background: white;
      box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      background: white;
      color: #333;
      box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
    .leaflet-container a.leaflet-popup-close-button {
      position: absolute;
      top: 0;
      right: 0;
      padding: 4px 4px 0 0;
      border: none;
      text-align: center;
      width: 18px;
      height: 14px;
      font: 16px/14px Tahoma, Verdana, sans-serif;
      color: #c3c3c3;
      text-decoration: none;
      font-weight: bold;
      background: transparent;
    }
    .leaflet-container a.leaflet-popup-close-button:hover {
      color: #999;
    }
    .leaflet-popup-scrolled {
      overflow: auto;
      border-bottom: 1px solid #ddd;
      border-top: 1px solid #ddd;
    }

    /* Marker cluster styles */
    .marker-cluster-small {
      background-color: rgba(181, 226, 140, 0.6);
    }
    .marker-cluster-small div {
      background-color: rgba(110, 204, 57, 0.6);
    }
    .marker-cluster-medium {
      background-color: rgba(241, 211, 87, 0.6);
    }
    .marker-cluster-medium div {
      background-color: rgba(240, 194, 12, 0.6);
    }
    .marker-cluster-large {
      background-color: rgba(253, 156, 115, 0.6);
    }
    .marker-cluster-large div {
      background-color: rgba(241, 128, 23, 0.6);
    }
    .marker-cluster {
      background-clip: padding-box;
      border-radius: 20px;
    }
    .marker-cluster div {
      width: 30px;
      height: 30px;
      margin-left: 5px;
      margin-top: 5px;
      text-align: center;
      border-radius: 15px;
      font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
    }
    .marker-cluster span {
      line-height: 30px;
    }

    /* Enhanced styles with performance optimizations */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      background: #f8f9fa;
    }

    #map {
      height: 100%;
      margin: 0;
      padding: 0;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1;
    }

    /* Remove marker shadows globally */
    .leaflet-marker-shadow {
      display: none !important;
    }

    /* Enhanced control buttons */
    .control-button {
      position: fixed;
      z-index: 10000;
      border: none;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      font-size: 1.4em;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .control-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    .control-button:active {
      transform: translateY(0);
    }

    #refresh-button {
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      color: #007bff;
    }

    #ar-button {
      top: 20px;
      right: 20px;
      background: rgba(128, 0, 128, 0.95); /* Purple background */
      color: white;
    }

    #locate-button {
      top: 80px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      color: #007bff;
    }

    /* AR View Styles */
    #ar-view {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: #000;
    }

    #ar-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #ar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #ar-info {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 500;
      z-index: 10001;
      text-align: center;
      max-width: 90%;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #exit-ar {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10001;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border: none;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      font-size: 1.2em;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    /* Enhanced popup styles */
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border: none;
    }

    .leaflet-popup-content {
      margin: 16px;
      font-size: 14px;
      line-height: 1.4;
    }

    .fountain-popup {
      min-width: 200px;
    }

    .fountain-popup h3 {
      margin: 0 0 8px 0;
      color: #2c3e50;
      font-size: 16px;
    }

    .fountain-popup .details {
      color: #7f8c8d;
      font-size: 13px;
      margin: 4px 0;
    }

    .nav-button {
      width: 100%;
      padding: 10px 16px;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-top: 12px;
      transition: all 0.2s ease;
    }

    .nav-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    /* Enhanced loading indicator */
    #loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      z-index: 10002;
      font-size: 14px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10003;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      animation: slideDown 0.3s ease;
    }

    .notification.success {
      background: rgba(76, 175, 80, 0.95);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .notification.error {
      background: rgba(244, 67, 54, 0.95);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .notification.info {
      background: rgba(33, 150, 243, 0.95);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* AR directional indicators */
    .ar-indicator {
      position: absolute;
      background: rgba(0, 123, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      color: white;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    /* Custom marker styles */
    .water-marker {
      background: #007bff;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    /* Responsive design */
    @media (max-width: 480px) {
      .control-button {
        width: 44px;
        height: 44px;
        font-size: 1.2em;
      }
      
      #ar-info {
        bottom: 20px;
        font-size: 0.9rem;
        padding: 10px 16px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <button id="refresh-button" class="control-button" title="Refresh Location">üîÑ</button>
  <button id="ar-button" class="control-button" title="AR Camera View">üì∑</button>
  <button id="locate-button" class="control-button" title="Find My Location">üìç</button>

  <div id="ar-view">
    <video id="ar-video" autoplay muted playsinline webkit-playsinline></video>
    <canvas id="ar-overlay"></canvas>
    <button id="exit-ar" title="Exit AR">‚úï</button>
    <div id="ar-info">Point your camera to find water sources</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <script>
    // Enhanced Water Finder App with Performance Optimizations
    
    // Global variables
    let map, markersCluster, locationMarker, userLocation = null;
    let arStream, deviceOrientationWatcher, animationFrameId;
    let currentHeading = 0, isARActive = false;
    let currentFetchController = null, lastFetchBounds = null;
    let fetchTimeout, fountainData = [];
    
    // Performance constants
    const MIN_ZOOM_FOR_FETCH = 10;
    const MAX_AR_DISTANCE = 1000;
    const HFOV_DEGREES = 75;
    const CACHE_EXPIRE_TIME = 15 * 60 * 1000; // 15 minutes
    const MAX_CACHE_ENTRIES = 100;
    
    // Enhanced caching system
    const bboxCache = new Map();
    const requestQueue = [];
    let isProcessingQueue = false;
    
    // Initialize map with optimized settings
    function initializeMap() {
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false,
        preferCanvas: true, // Better performance for many markers
        renderer: L.canvas({ padding: 0.5 })
      }).setView([0, 0], 2);
      
      // Use reliable OpenStreetMap tile layer
      L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=KtkfQkx8DxnyjkBQfUeS', {
  tileSize: 512,
  zoomOffset: -1,
  attribution: '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
}).addTo(map);
      
      // Enhanced clustering with better performance
      markersCluster = L.markerClusterGroup({
        maxClusterRadius: 60,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 17,
        chunkedLoading: true,
        chunkDelay: 50, // Smooth loading
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          const size = count < 10 ? 'small' : count < 100 ? 'medium' : 'large';
          return L.divIcon({
            html: `<div style="background: rgba(0,123,255,0.8); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,123,255,0.3);">${count}</div>`,
            className: 'custom-cluster-icon',
            iconSize: [40, 40]
          });
        }
      });
      map.addLayer(markersCluster);
    }
    
    // Enhanced location handling
    function initializeLocation() {
      showLoadingIndicator('Finding your location...');
      
      if (!navigator.geolocation) {
        hideLoadingIndicator();
        showNotification('Geolocation is not supported by this browser', 'error');
        return;
      }
      
      const options = {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 60000 // Cache location for 1 minute
      };
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          
          if (locationMarker) map.removeLayer(locationMarker);
          
          // Enhanced location marker
          locationMarker = L.circleMarker([lat, lng], {
            radius: 12,
            fillColor: '#007bff',
            color: 'white',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);
          
          userLocation = L.latLng(lat, lng);
          map.setView(userLocation, Math.min(16, Math.max(12, 20 - Math.log10(accuracy))));
          
          // Fetch nearby fountains
          fetchNearbyFountains(lat, lng, 2000);
          hideLoadingIndicator();
          showNotification('Location found!', 'success');
          
          // Add some demo markers for testing
          addDemoMarkers(lat, lng);
        },
        (error) => {
          hideLoadingIndicator();
          let message = 'Unable to get your location. ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              message += 'Please enable location permissions.';
              break;
            case error.POSITION_UNAVAILABLE:
              message += 'Location information unavailable.';
              break;
            case error.TIMEOUT:
              message += 'Location request timed out.';
              break;
          }
          showNotification(message, 'error');
        },
        options
      );
    }
    
    // Optimized nearby fetch with better error handling
    async function fetchNearbyFountains(lat, lng, radius) {
      if (currentFetchController) {
        currentFetchController.abort();
      }
      
      currentFetchController = new AbortController();
      const query = `[out:json][timeout:25];node["amenity"="drinking_water"](around:${radius},${lat},${lng});out center;`;
      
      try {
        showLoadingIndicator('Loading water sources...');
        
        const response = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: query,
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          signal: currentFetchController.signal
        });
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        fountainData = data.elements || [];
        renderOptimizedMarkers(fountainData);
        
        if (fountainData.length === 0) {
          showNotification('No water sources found nearby', 'info');
        } else {
          showNotification(`Found ${fountainData.length} water sources!`, 'success');
        }
        
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Fetch error:', error);
          showNotification('Failed to load water sources. Retrying...', 'error');
          // Retry after delay
          setTimeout(() => fetchNearbyFountains(lat, lng, radius), 3000);
        }
      } finally {
        hideLoadingIndicator();
        currentFetchController = null;
      }
    }
    
    // Enhanced marker rendering with performance optimizations
    function renderOptimizedMarkers(elements) {
      markersCluster.clearLayers();
      
      if (!elements || elements.length === 0) return;
      
      const markers = [];
      const maxMarkers = getMaxMarkersForZoom(map.getZoom());
      const visibleElements = elements.slice(0, maxMarkers);
      
      // Batch processing for better performance
      const processBatch = (startIndex) => {
        const batchSize = 50;
        const endIndex = Math.min(startIndex + batchSize, visibleElements.length);
        
        for (let i = startIndex; i < endIndex; i++) {
          const element = visibleElements[i];
          const lat = element.lat ?? element.center?.lat;
          const lng = element.lon ?? element.center?.lon;
          
          if (!lat || !lng) continue;
          
          const name = element.tags?.name || 'Drinking Water';
          const operator = element.tags?.operator;
          const access = element.tags?.access || 'public';
          const fee = element.tags?.fee;
          
          // Calculate distance if user location available
          let distanceText = '';
          if (userLocation) {
            const distance = userLocation.distanceTo([lat, lng]);
            distanceText = `${Math.round(distance)}m away`;
          }
          
          // Enhanced popup content
          const popupContent = `
            <div class="fountain-popup">
              <h3>${name}</h3>
              ${distanceText ? `<div class="details">üìç ${distanceText}</div>` : ''}
              ${operator ? `<div class="details">üè¢ Operator: ${operator}</div>` : ''}
              <div class="details">üö∞ Access: ${access}</div>
              ${fee ? `<div class="details">üí∞ Fee: ${fee}</div>` : ''}
              <button class="nav-button" onclick="navigateToLocation(${lat}, ${lng})">
                üß≠ Navigate Here
              </button>
            </div>
          `;
          
          // Custom marker icon without shadow
          const customIcon = L.divIcon({
            className: 'water-marker',
            html: 'üíß',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
          });
          
          const marker = L.marker([lat, lng], { 
            icon: customIcon,
            riseOnHover: true 
          }).bindPopup(popupContent);
          
          markers.push(marker);
        }
        
        if (endIndex < visibleElements.length) {
          // Process next batch
          requestAnimationFrame(() => processBatch(endIndex));
        } else {
          // Add all markers at once
          markersCluster.addLayers(markers);
        }
      };
      
      processBatch(0);
    }
    
    // Smart marker limit based on zoom and device performance
    function getMaxMarkersForZoom(zoom) {
      const isMobile = window.innerWidth < 768;
      const baseLimit = isMobile ? 100 : 200;
      
      if (zoom < 12) return Math.floor(baseLimit * 0.3);
      if (zoom < 15) return Math.floor(baseLimit * 0.6);
      if (zoom < 17) return baseLimit;
      return baseLimit * 1.5;
    }
    
    // Enhanced AR functionality
    async function startARMode() {
      if (isARActive) return;
      
      try {
        showLoadingIndicator('Starting AR camera...');
        
        if (!navigator.mediaDevices?.getUserMedia) {
          throw new Error('Camera access not supported');
        }
        
        // Request camera with optimal settings
        arStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920, min: 1280 },
            height: { ideal: 1080, min: 720 },
            frameRate: { ideal: 30, min: 15 }
          },
          audio: false
        });
        
        const arVideo = document.getElementById('ar-video');
        const arCanvas = document.getElementById('ar-overlay');
        
        arVideo.srcObject = arStream;
        await arVideo.play();
        
        // Set canvas size
        arCanvas.width = window.innerWidth;
        arCanvas.height = window.innerHeight;
        
        // Request orientation permissions
        if (typeof DeviceOrientationEvent !== 'undefined' && 
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          const permission = await DeviceOrientationEvent.requestPermission();
          if (permission !== 'granted') {
            throw new Error('Device orientation permission denied');
          }
        }
        
        startARTracking();
        isARActive = true;
        
        document.getElementById('ar-view').style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        hideLoadingIndicator();
        showNotification('AR mode activated! Point camera around to find water sources', 'success');
        
      } catch (error) {
        console.error('AR Error:', error);
        hideLoadingIndicator();
        showNotification(`AR not available: ${error.message}`, 'error');
        stopAR();
      }
    }
    
    function startARTracking() {
      // Enhanced device orientation handling
      const handleOrientation = (event) => {
        if (event.absolute && event.alpha !== null) {
          currentHeading = event.alpha;
        } else if (event.webkitCompassHeading !== null) {
          currentHeading = event.webkitCompassHeading;
        } else if (event.alpha !== null) {
          currentHeading = event.alpha;
        }
      };
      
      deviceOrientationWatcher = handleOrientation;
      
      if ('ondeviceorientationabsolute' in window) {
        window.addEventListener('deviceorientationabsolute', deviceOrientationWatcher);
      } else {
        window.addEventListener('deviceorientation', deviceOrientationWatcher);
      }
      
      // Start render loop
      arRenderLoop();
    }
    
    function arRenderLoop() {
      if (!isARActive) return;
      
      drawAROverlay();
      animationFrameId = requestAnimationFrame(arRenderLoop);
    }
    
    function drawAROverlay() {
      const canvas = document.getElementById('ar-overlay');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!userLocation || !fountainData.length) {
        document.getElementById('ar-info').textContent = 'No water sources data available';
        return;
      }
      
      // Calculate visible fountains
      const nearbyFountains = fountainData
        .map(fountain => {
          const lat = fountain.lat ?? fountain.center?.lat;
          const lng = fountain.lon ?? fountain.center?.lon;
          if (!lat || !lng) return null;
          
          const fountainPos = L.latLng(lat, lng);
          const distance = userLocation.distanceTo(fountainPos);
          
          if (distance > MAX_AR_DISTANCE) return null;
          
          // Calculate bearing
          const dLng = L.Util.degToRad(lng - userLocation.lng);
          const lat1 = L.Util.degToRad(userLocation.lat);
          const lat2 = L.Util.degToRad(lat);
          
          const y = Math.sin(dLng) * Math.cos(lat2);
          const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
          let bearing = (L.Util.radToDeg(Math.atan2(y, x)) + 360) % 360;
          
          // Calculate relative angle
          let relativeAngle = bearing - currentHeading;
          while (relativeAngle <= -180) relativeAngle += 360;
          while (relativeAngle > 180) relativeAngle -= 360;
          
          return {
            name: fountain.tags?.name || 'Water Source',
            distance: Math.round(distance),
            relativeAngle,
            bearing,
            lat,
            lng
          };
        })
        .filter(f => f && Math.abs(f.relativeAngle) <= HFOV_DEGREES / 2)
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 5); // Show only 5 nearest
      
      // Draw AR indicators
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      
      nearbyFountains.forEach((fountain, index) => {
        const screenX = centerX + (fountain.relativeAngle / (HFOV_DEGREES / 2)) * (centerX * 0.8);
        const distanceRatio = Math.max(0.2, 1 - (fountain.distance / MAX_AR_DISTANCE));
        const screenY = centerY - (distanceRatio * centerY * 0.4);
        const size = 20 + (distanceRatio * 20);
        
        // Draw indicator circle
        ctx.fillStyle = `rgba(0, 123, 255, ${0.8 + distanceRatio * 0.2})`;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.lineWidth = 3;
        
        ctx.beginPath();
        ctx.arc(screenX, screenY, size, 0, 2 * Math.PI);
        ctx.fill();
        ctx.stroke();
        
        // Draw distance text
        ctx.fillStyle = 'white';
        ctx.font = `bold ${12 + distanceRatio * 4}px Arial`;
        ctx.textAlign = 'center';
        ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
        ctx.shadowBlur = 4;
        
        ctx.fillText(`${fountain.distance}m`, screenX, screenY + size + 20);
        
        // Draw name for closest fountain
        if (index === 0) {
          ctx.font = `${10 + distanceRatio * 2}px Arial`;
          ctx.fillText(fountain.name, screenX, screenY + size + 38);
        }
        
        ctx.shadowBlur = 0;
      });
      
      // Update info display
      const infoEl = document.getElementById('ar-info');
      if (nearbyFountains.length > 0) {
        const nearest = nearbyFountains[0];
        infoEl.textContent = `${nearest.distance}m to ${nearest.name}`;
      